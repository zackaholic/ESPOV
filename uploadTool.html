<!DOCTYPE HTML>
<html>
  <head>
  </head>
  <body id="page" style="width:900px; height:800px">
    <canvas id="myCanvas" width="900" height="300" style="touch-action: none; border:1px solid; background-color: #000000"></canvas>
    <p></p>
    <div id="uploadButton" style="cursor: pointer; border:1px solid; background-color:#b3e7ff; width:100px; height:50px; display:inline-block">
     <h3 style="font-family:Arial; text-align:center">Upload</h3> 
    </div>
    <div id="colorPicker" style="width: 510px; touch-action: none; display: inline-block; float:right">
      
    </div>

    <script type="text/javascript">
      var canvas = document.getElementById('myCanvas');
      var palette = document.getElementById('colorPicker')
      var ctx = canvas.getContext('2d');
      var pixelSize = 30;
      var canvasRows = 10;
      var canvasColumns = 30;
      var Pixels = new Array(canvasRows * canvasColumns);  
      var drawing, erasing, eraseSelected, drawSelected;
      var drawColor;
      var eraseColor = "#404040";
      var httpRequest;

      document.getElementById("uploadButton").onclick = function() {
        Pixels.upload();
      };

      Pixels.upload = function() {
        for (var i = 0; i < Pixels.length; i++) {
          Pixels[i] = Pixels[i] === undefined ? 0 : Pixels[i];
        }
        console.log(Pixels);
        //TODO: try sending as padded hex values, no spaces
        httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = logContents; //do I need a response?
        httpRequest.open('POST', 'upload');
        httpRequest.send(Pixels);
      }

      function logContents() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            console.log(httpRequest.responseText);
          } else {
            console.log('There was a problem with the request.');
          }
        }
      }

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        var xPos = evt.clientX - rect.left;
        var yPos = evt.clientY - rect.top;
        return {x : xPos, y : yPos};
      }

      Pixels.getPixel = function(row, col) {

      };

      Pixels.setPixel = function(row, col, color) {
        var p = row + col * canvasRows;

        if (color === 0) {
          Pixels[p] = 0;
          ctx.fillStyle = eraseColor;
          ctx.fillRect(col * pixelSize, row * pixelSize, pixelSize, pixelSize);
        } else {
          Pixels[p] = convertTo8Bit(color);
          ctx.fillStyle = drawColor;
          ctx.fillRect(col * pixelSize, row * pixelSize, pixelSize, pixelSize);
        }
      };

      function convertTo8Bit(color) {
        var color = parseInt(color.replace(/^#/, ''), 16);
        var red = color >> 21;
        var green = color >> 13 & 0x07;
        var blue = color >> 6 & 0x03;
        var color8Bit = (red << 5) | (green << 2) | blue;
        return color8Bit;
      }

      function handleMove(evt) {
        var row, col;
        var mouse = getMousePos(canvas, evt);

        col = Math.floor(mouse.x / pixelSize);
        row = Math.floor(mouse.y / pixelSize);

        if (erasing) {
          Pixels.setPixel(row, col, 0);
        }
        if (drawing) {
          Pixels.setPixel(row, col, drawColor);
        }

      }

      function handleMouseUp(evt) {
        drawing = false;
        erasing = false;        
      }

      function handleMouseDown(evt) {
        //evt contains clientX and clientY- replace getMousePos???
        var row, col;
        var mouse = getMousePos(canvas, evt);

        col = Math.floor(mouse.x / pixelSize);
        row = Math.floor(mouse.y / pixelSize);

        if (eraseSelected) {
          erasing = true;
          drawing = false;
          Pixels.setPixel(row, col, 0);
        } 
        if (drawSelected) {
          drawing = true;
          erasing = false;
          Pixels.setPixel(row, col, drawColor);
        }       
      }

      var createBorderPatrol = function() {
        var lastElement;
        var currentElement;

        return function(element) {
          if (this.currentElement) {
            this.lastElement = this.currentElement;
            this.lastElement.style.borderColor = this.lastElement.id;
          }
          this.currentElement = element;
          this.currentElement.style.borderColor = "#000000";
        }
      }
      var setBorder = createBorderPatrol();

      function pickerMouseDown(evt) {
        eraseSelected = false;
        drawSelected = true;
        drawColor = evt.srcElement.id;
        setBorder(evt.srcElement);
      }




      var colorPicker = document.getElementById("colorPicker");
      //TODO: try an indexed color palette suitable for actual LED values
      //also gamma correction??
      function createColorPicker(colors, parent) {
        function padHex(num) {
          var paddedNum = num.toString(16);
          if (paddedNum.length == 1) {
            return '0' + paddedNum;
          }
          return paddedNum;
        }

        this.parent = parent;
        this.numColors = colors;
        var color;

        for (var r = 0; r < 255; r+= 37) {
          for (var g = 0; g < 255; g+= 37) {
            for (var b = 0; b < 255; b+= 85) {
              color = '#' + padHex(r) + padHex(g) + padHex(b);
              var e = document.createElement("div");
              e.id = color;
              e.setAttribute("style", "margin: 0px; border: 2px solid " + color + "; padding: 0px; display: inline-block; width: 20px; height: 20px; background-color: " + color);
              e.addEventListener("mousedown", pickerMouseDown);
              parent.appendChild(e);
            }
          }
        }        
      }

      createColorPicker(256, colorPicker);

      canvas.addEventListener("mousemove", handleMove);
      canvas.addEventListener("mousedown", handleMouseDown, false);
      canvas.addEventListener("mouseup", handleMouseUp);
      //these don't work yet
      canvas.addEventListener("touchmove", function(){console.log('hi');});
      canvas.addEventListener("touchstart", handleMouseDown);
      canvas.addEventListener("touchend", handleMouseUp);


    </script>
  </body>
</html>















